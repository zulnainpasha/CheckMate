{% extends "base.html" %} {% block title %}Teacher Dashboard{% endblock %} {%
block content %}

<style>
  :root {
    --primary-blue: #2563eb;
    --primary-dark: #1e40af;
    --success-green: #10b981;
    --warning-orange: #f59e0b;
    --danger-red: #ef4444;
    --neutral-50: #f9fafb;
    --neutral-100: #f3f4f6;
    --neutral-200: #e5e7eb;
    --neutral-300: #d1d5db;
    --neutral-600: #4b5563;
    --neutral-700: #374151;
    --neutral-800: #1f2937;
    --neutral-900: #111827;
  }

  .dashboard-header {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--primary-dark) 100%
    );
    border-radius: 12px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
  }

  .dashboard-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .dashboard-subtitle {
    opacity: 0.95;
    font-size: 0.95rem;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn-header {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-header:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
    color: white;
  }

  .btn-header-primary {
    background: white;
    color: var(--primary-blue);
    border: none;
  }

  .btn-header-primary:hover {
    background: var(--neutral-100);
    color: var(--primary-dark);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid var(--neutral-200);
    transition: all 0.2s ease;
  }

  .stat-card:hover {
    border-color: var(--neutral-300);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .stat-label {
    color: var(--neutral-600);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .section-card {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--neutral-200);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .section-header {
    padding: 1.25rem 1.5rem;
    background: var(--neutral-50);
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--neutral-800);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
  }

  .section-badge {
    background: var(--primary-blue);
    color: white;
    padding: 0.25rem 0.625rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
  }

  .session-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--neutral-100);
    transition: background 0.2s ease;
  }

  .session-item:last-child {
    border-bottom: none;
  }

  .session-item:hover {
    background: var(--neutral-50);
  }

  .session-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--neutral-900);
    margin-bottom: 0.375rem;
  }

  .session-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 0.5rem;
  }

  .badge-custom {
    padding: 0.25rem 0.625rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .badge-class {
    background: #e0e7ff;
    color: #3730a3;
  }

  .badge-active {
    background: #d1fae5;
    color: #065f46;
  }

  .badge-validating {
    background: #fef3c7;
    color: #92400e;
  }

  .session-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: var(--neutral-600);
    font-size: 0.8125rem;
    margin-bottom: 0.625rem;
  }

  .emergency-code-box {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #fef2f2;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #fecaca;
  }

  .emergency-code {
    font-family: "Courier New", monospace;
    font-weight: 700;
    color: #dc2626;
    font-size: 0.875rem;
    letter-spacing: 1px;
  }

  .session-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .btn-action {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .btn-view {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-view:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
  }

  .btn-success {
    background: var(--success-green);
    color: white;
  }

  .btn-success:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .btn-warning {
    background: var(--warning-orange);
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
  }

  .btn-danger {
    background: var(--danger-red);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }

  .btn-outline {
    background: transparent;
    border: 1.5px solid var(--neutral-300);
    color: var(--neutral-700);
  }

  .btn-outline:hover {
    background: var(--neutral-100);
    border-color: var(--neutral-400);
  }

  .btn-copy {
    background: transparent;
    border: none;
    color: #dc2626;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
  }

  .btn-copy:hover {
    color: #991b1b;
    transform: scale(1.1);
  }

  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-icon {
    font-size: 3rem;
    color: var(--neutral-300);
    margin-bottom: 1rem;
  }

  .empty-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: 0.5rem;
  }

  .empty-text {
    color: var(--neutral-500);
    margin-bottom: 1.5rem;
  }

  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
  }

  .quick-action-card {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border: 1px solid var(--neutral-200);
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .quick-action-card:hover {
    border-color: var(--primary-blue);
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .quick-action-icon {
    font-size: 2rem;
    color: var(--primary-blue);
    margin-bottom: 1rem;
  }

  .quick-action-title {
    font-weight: 600;
    color: var(--neutral-800);
    margin-bottom: 1rem;
  }

  .countdown-timer {
    font-family: "Courier New", monospace;
    font-weight: 700;
  }

  /* Modal Styling */
  .modal-header-custom {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--primary-dark) 100%
    );
    color: white;
    padding: 1.25rem 1.5rem;
  }

  .modal-title-custom {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Dark Mode - Enhanced Visibility */
  html[data-theme="dark"] {
    --stat-card-bg: #1c2128;
    --session-hover: #21262d;
    --border-color-dark: #30363d;
    --text-primary-dark: #e6edf3;
    --text-secondary-dark: #8b949e;
  }

  html[data-theme="dark"] .section-card,
  html[data-theme="dark"] .stat-card {
    background: var(--stat-card-bg);
    border-color: var(--border-color-dark);
  }

  html[data-theme="dark"] .section-header {
    background: #161b22;
    border-color: var(--border-color-dark);
  }

  html[data-theme="dark"] .session-item {
    border-color: var(--border-color-dark);
  }

  html[data-theme="dark"] .session-item:hover {
    background: var(--session-hover);
  }

  html[data-theme="dark"] .session-title,
  html[data-theme="dark"] .section-title,
  html[data-theme="dark"] .stat-value {
    color: var(--text-primary-dark);
  }

  html[data-theme="dark"] .stat-label,
  html[data-theme="dark"] .session-meta {
    color: var(--text-secondary-dark);
  }

  html[data-theme="dark"] .badge-class {
    background: #1e3a8a;
    color: #93c5fd;
  }

  html[data-theme="dark"] .badge-active {
    background: #064e3b;
    color: #6ee7b7;
  }

  html[data-theme="dark"] .badge-validating {
    background: #78350f;
    color: #fcd34d;
  }

  html[data-theme="dark"] .emergency-code-box {
    background: #450a0a;
    border-color: #7f1d1d;
  }

  html[data-theme="dark"] .emergency-code {
    color: #fca5a5;
  }

  html[data-theme="dark"] .btn-view {
    background: #21262d;
    color: var(--text-primary-dark);
    border-color: var(--border-color-dark);
  }

  html[data-theme="dark"] .btn-view:hover {
    background: #30363d;
    border-color: #484f58;
  }

  html[data-theme="dark"] .btn-outline {
    background: transparent;
    border-color: var(--border-color-dark);
    color: var(--text-primary-dark);
  }

  html[data-theme="dark"] .btn-outline:hover {
    background: #21262d;
    border-color: #484f58;
  }

  html[data-theme="dark"] .btn-copy {
    color: #fca5a5;
  }

  html[data-theme="dark"] .btn-copy:hover {
    color: #fecaca;
  }

  html[data-theme="dark"] .quick-action-card {
    background: #1c2128;
    border-color: var(--border-color-dark);
  }

  html[data-theme="dark"] .quick-action-card:hover {
    background: #21262d;
    border-color: #1f6feb;
  }

  html[data-theme="dark"] .quick-action-icon {
    color: #58a6ff;
  }

  html[data-theme="dark"] .quick-action-title {
    color: var(--text-primary-dark);
  }

  html[data-theme="dark"] .empty-icon {
    color: #484f58;
  }

  html[data-theme="dark"] .empty-title {
    color: var(--text-primary-dark);
  }

  html[data-theme="dark"] .empty-text {
    color: var(--text-secondary-dark);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .dashboard-header {
      padding: 1.5rem;
    }

    .dashboard-title {
      font-size: 1.5rem;
    }

    .header-actions {
      flex-direction: column;
      width: 100%;
    }

    .btn-header {
      width: 100%;
      text-align: center;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .session-actions {
      width: 100%;
    }

    .btn-action {
      flex: 1;
    }
  }
</style>

<!-- Dashboard Header -->
<div class="dashboard-header">
  <div
    class="d-flex justify-content-between align-items-center flex-wrap gap-3"
  >
    <div>
      <h1 class="dashboard-title">Teacher Dashboard</h1>
      <p class="dashboard-subtitle mb-0">Welcome back, {{ user.name }}</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('teacher_reports') }}" class="btn-header">
        <i class="fas fa-flag me-2"></i>Reports
      </a>
      <a
        href="{{ url_for('create_session') }}"
        class="btn-header btn-header-primary"
      >
        <i class="fas fa-plus me-2"></i>New Session
      </a>
    </div>
  </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-value" style="color: var(--primary-blue)">
      {{ sessions|length }}
    </div>
    <div class="stat-label">Active Sessions</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" style="color: var(--success-green)">
      {{ ended_sessions|length }}
    </div>
    <div class="stat-label">Completed Today</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" style="color: var(--neutral-600)">
      {{ user.sessions|length }}
    </div>
    <div class="stat-label">Total Sessions</div>
  </div>
</div>

<!-- Active Sessions -->
<div class="section-card">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fas fa-broadcast-tower"></i>
      Active Sessions {% if sessions %}<span class="section-badge"
        >{{ sessions|length }}</span
      >{% endif %}
    </h2>
  </div>
  {% if sessions %} {% for session in sessions %}
  <div class="session-item" data-session-id="{{ session.id }}">
    <h3 class="session-title">{{ session.subject }}</h3>

    <div class="session-badges">
      <span class="badge-custom badge-class">
        <i class="fas fa-door-open"></i> Class {{ session.class_section }}
      </span>
      {% if session.validation_end_time %}
      <span class="badge-custom badge-validating">
        <i class="fas fa-clock"></i> Validating
        <span id="countdown-{{ session.id }}" class="countdown-timer"></span>
      </span>
      {% else %}
      <span class="badge-custom badge-active">
        <i class="fas fa-wifi"></i> Active
      </span>
      {% endif %}
    </div>

    <div class="session-meta">
      <span>
        <i class="fas fa-clock me-1"></i>
        {{ utc_to_local_short(session.start_time) }} - {{
        utc_to_local_short(session.end_time) }}
      </span>
    </div>

    <div class="emergency-code-box mb-2">
      <span style="font-size: 0.75rem; opacity: 0.8">Emergency Code:</span>
      <code class="emergency-code">{{ session.emergency_code }}</code>
      <button
        class="btn-copy"
        onclick="copyCode('{{ session.emergency_code }}')"
        title="Copy code"
      >
        <i class="fas fa-copy"></i>
      </button>
    </div>

    <div class="session-actions">
      {% if session.validation_end_time %}
      <button
        class="btn-action btn-danger"
        onclick="showFinalizeModal({{ session.id }})"
      >
        <i class="fas fa-check-double"></i>Finalize
      </button>
      <form
        method="POST"
        action="{{ url_for('force_finalize_session', session_id=session.id) }}"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn-action btn-outline"
          onclick="return confirm('Force end session? Pending students will be marked as failed.')"
        >
          <i class="fas fa-times"></i>Force End
        </button>
      </form>
      {% else %}
      <a
        href="{{ url_for('view_attendance', session_id=session.id) }}"
        class="btn-action btn-view"
      >
        <i class="fas fa-eye"></i>View
      </a>
      <form
        method="POST"
        action="{{ url_for('confirm_attendance', session_id=session.id) }}"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn-action btn-success"
          onclick="return confirm('Mark all pending students as present?')"
        >
          <i class="fas fa-check"></i>Confirm All
        </button>
      </form>
      <form
        method="POST"
        action="{{ url_for('start_validation', session_id=session.id) }}"
        class="d-inline"
      >
        <button type="submit" class="btn-action btn-warning">
          <i class="fas fa-user-check"></i>Validate
        </button>
      </form>
      <form
        method="POST"
        action="{{ url_for('manual_end_session', session_id=session.id) }}"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn-action btn-outline"
          onclick="return confirm('Stop accepting new attendance?')"
        >
          <i class="fas fa-stop"></i>End
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endfor %} {% else %}
  <div class="empty-state">
    <div class="empty-icon"><i class="fas fa-broadcast-tower"></i></div>
    <h3 class="empty-title">No Active Sessions</h3>
    <p class="empty-text">
      Create your first attendance session to get started
    </p>
    <a href="{{ url_for('create_session') }}" class="btn-action btn-success">
      <i class="fas fa-plus"></i>Create Session
    </a>
  </div>
  {% endif %}
</div>

<!-- Recent Sessions -->
<div class="section-card">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fas fa-history"></i>
      Recent Sessions {% if ended_sessions %}<span class="section-badge"
        >{{ ended_sessions|length }}</span
      >{% endif %}
    </h2>
  </div>
  {% if ended_sessions %} {% for session in ended_sessions %}
  <div class="session-item">
    <h3 class="session-title">{{ session.subject }}</h3>

    <div class="session-badges">
      <span class="badge-custom badge-class">
        <i class="fas fa-door-open"></i> Class {{ session.class_section }}
      </span>
      <span class="badge-custom badge-active">
        <i class="fas fa-users"></i>{{ session.attendance_count or 0 }} present
      </span>
    </div>

    <div class="session-meta">
      <span>
        <i class="fas fa-calendar-alt me-1"></i>
        {{ utc_to_local_date(session.end_time) }} at {{
        utc_to_local_short(session.end_time) }}
      </span>
    </div>

    <div class="session-actions">
      <a
        href="{{ url_for('view_attendance', session_id=session.id) }}"
        class="btn-action btn-view"
      >
        <i class="fas fa-chart-bar"></i>View Report
      </a>
      <form
        method="POST"
        action="{{ url_for('delete_report', session_id=session.id) }}"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn-action btn-outline"
          onclick="return confirm('Permanently delete this session report?')"
        >
          <i class="fas fa-trash"></i>Delete
        </button>
      </form>
    </div>
  </div>
  {% endfor %} {% else %}
  <div class="empty-state" style="padding: 3rem 2rem">
    <div class="empty-icon"><i class="fas fa-history"></i></div>
    <h3 class="empty-title">No Completed Sessions</h3>
    <p class="empty-text mb-0">Your completed sessions will appear here</p>
  </div>
  {% endif %}
</div>

<!-- Quick Actions -->
<div class="section-card">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fas fa-rocket"></i>
      Quick Actions
    </h2>
  </div>
  <div class="quick-actions-grid">
    <div class="quick-action-card">
      <div class="quick-action-icon"><i class="fas fa-plus-circle"></i></div>
      <h4 class="quick-action-title">Create Session</h4>
      <a href="{{ url_for('create_session') }}" class="btn-action btn-success">
        <i class="fas fa-plus"></i>New Session
      </a>
    </div>
    <div class="quick-action-card">
      <div class="quick-action-icon" style="color: var(--warning-orange)">
        <i class="fas fa-flag"></i>
      </div>
      <h4 class="quick-action-title">Report Student</h4>
      <a href="{{ url_for('teacher_reports') }}" class="btn-action btn-warning">
        <i class="fas fa-flag"></i>Go to Reports
      </a>
    </div>
  </div>
</div>

<!-- Finalize Modal -->
<div class="modal fade" id="finalizeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header modal-header-custom">
        <h5 class="modal-title modal-title-custom">
          <i class="fas fa-clipboard-check"></i>
          Finalize Attendance
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Set final status for students who haven't validated.
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="finalizeStudentsTable">
              <tr>
                <td colspan="3" class="text-center py-3">
                  <div class="spinner-border spinner-border-sm me-2"></div>
                  Loading students...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn-action btn-outline"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn-action btn-danger"
          onclick="confirmFinalize()"
        >
          <i class="fas fa-check"></i>Finalize Session
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  let currentSessionId = null;
  let finalizeModal = null;

  document.addEventListener('DOMContentLoaded', function() {
    finalizeModal = new bootstrap.Modal(document.getElementById('finalizeModal'));

    {% for session in sessions %}
      {% if session.validation_end_time %}
        startCountdown({{ session.id }}, "{{ session.validation_end_time.isoformat() }}Z");
      {% endif %}
    {% endfor %}
  });

  function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
      showAlert('Emergency code copied to clipboard!', 'success');
    }).catch(() => {
      showAlert('Failed to copy code', 'danger');
    });
  }

  function startCountdown(sessionId, endTimeISO) {
    const endTime = new Date(endTimeISO).getTime();
    const countdownEl = document.getElementById(`countdown-${sessionId}`);

    function updateCountdown() {
      const now = Date.now();
      const distance = endTime - now;

      if (distance <= 0) {
        countdownEl.innerHTML = 'Expired';
        showFinalizeModal(sessionId);
        return;
      }

      const minutes = Math.floor(distance / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      countdownEl.innerHTML = ` ${minutes}:${seconds.toString().padStart(2, '0')}`;

      setTimeout(updateCountdown, 1000);
    }

    updateCountdown();
  }

  async function showFinalizeModal(sessionId) {
    currentSessionId = sessionId;
    const tableBody = document.getElementById('finalizeStudentsTable');
    tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-3"><div class="spinner-border spinner-border-sm me-2"></div>Loading...</td></tr>';

    try {
      const response = await fetch(`/get_teacher_session_status/${sessionId}`);
      const data = await response.json();

      tableBody.innerHTML = '';

      if (data.pending_students && data.pending_students.length > 0) {
        data.pending_students.forEach(student => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHtml(student.name)}</td>
            <td><span class="badge bg-warning">Pending</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" onclick="setStudentStatus(this, 'present')">Present</button>
                <button class="btn btn-outline-danger" onclick="setStudentStatus(this, 'absent')">Absent</button>
              </div>
            </td>
          `;
          row.dataset.attendanceId = student.attendance_id;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-success py-3">All students validated!</td></tr>';
      }

      finalizeModal.show();
    } catch (error) {
      tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger py-3">Error loading data</td></tr>';
    }
  }

  function setStudentStatus(button, status) {
    const row = button.closest('tr');
    const statusCell = row.cells[1];

    const buttons = row.querySelectorAll('.btn');
    buttons.forEach(btn => {
      btn.classList.remove('btn-success', 'btn-danger');
      btn.classList.add('btn-outline-success', 'btn-outline-danger');
    });

    button.classList.remove(`btn-outline-${status === 'present' ? 'success' : 'danger'}`);
    button.classList.add(`btn-${status === 'present' ? 'success' : 'danger'}`);

    statusCell.innerHTML = `<span class="badge bg-${status === 'present' ? 'success' : 'danger'}">${status === 'present' ? 'Present' : 'Absent'}</span>`;
    row.dataset.finalStatus = status;
  }

  async function confirmFinalize() {
    if (!currentSessionId) return;

    const overrides = {};
    document.querySelectorAll('#finalizeStudentsTable tr[data-attendance-id]').forEach(row => {
      if (row.dataset.finalStatus) {
        overrides[row.dataset.attendanceId] = row.dataset.finalStatus;
      }
    });

    try {
      const response = await fetch(`/finalize_attendance/${currentSessionId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ overrides }),
      });

      const data = await response.json();

      if (data.success) {
        showAlert('Session finalized successfully!', 'success');
        finalizeModal.hide();
        setTimeout(() => location.reload(), 1000);
      } else {
        showAlert(data.message || 'Error finalizing session', 'danger');
      }
    } catch (error) {
      showAlert('Error finalizing session', 'danger');
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
    return text.toString().replace(/[&<>"']/g, m => map[m]);
  }

  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    alertDiv.innerHTML = `
      ${escapeHtml(message)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
  }
</script>
{% endblock %}
